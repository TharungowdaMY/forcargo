{% extends "base.html" %}
{% block content %}

<h1 class="page-title">Booking Management</h1>

<div class="neon-box">

<table style="width:100%; color:white; border-collapse: collapse;">
    <tr style="background:#111;">
        <th>ID</th>
        <th>Flight</th>
        <th>Weights</th>
        <th>Price/kg</th>
        <th>Total</th>
        <th>Status</th>
        <th>Action</th>
    </tr>

{% for b in bookings %}
<tr style="text-align:center; border-bottom:1px solid #333;">
    <td>{{ b['id'] }}</td>
    <td>{{ b['flight_id'] }}</td>

    <td>
        Actual: {{ b['actual_weight'] or 0 }} kg<br>
        Volumetric: {{ (b['volumetric_weight'] or 0)|round(2) }} kg<br>
        Charged: <b>{{ (b['chargeable_weight'] or 0)|round(2) }} kg</b>
    </td>

    <td>‚Çπ{{ b['price'] }}</td>
    <td><b>‚Çπ{{ (b['total'] or 0)|round(2) }}</b></td>

    <td>{{ b['status'] }}</td>

    <td>
    {% if b['status'] == "HOLD" %}

        <div style="display:flex; flex-direction:column; gap:6px; align-items:center;">

            <!-- ‚è≥ HOLD TIMER -->
            <span class="hold-timer"
                  data-expiry="{{ b['expires_at'] }}">
                ‚è≥ Holding...
            </span>

            <!-- üí¨ CHAT BUTTON -->
            <a href="/chat/{{ b['id'] }}"
               style="
                   padding:4px 10px;
                   background:#ff0077;
                   color:white;
                   border-radius:6px;
                   font-size:12px;
                   text-decoration:none;
               ">
                üí¨ Chat
            </a>

            <!-- üîä BEEP -->
            <audio class="beep">
                <source src="{{ url_for('static', filename='beep.mp3') }}" type="audio/mpeg">
            </audio>

        </div>

    {% else %}

        {{ b['status'] }}
        <br>

        <!-- üí¨ CHAT ALSO AFTER CONFIRM -->
        <a href="/chat/{{ b['id'] }}"
           style="
               padding:4px 10px;
               background:#444;
               color:white;
               border-radius:6px;
               font-size:12px;
               text-decoration:none;
           ">
            üí¨ Chat
        </a>

    {% endif %}
</td>

</tr>
{% endfor %}
</table>
<!-- AUDIO ALERT FOR FINAL 10 SECONDS -->
<audio id="warningSound">
    <source src="https://www.soundjay.com/buttons/sounds/beep-05.mp3">
</audio>

<script>
function updateTimers() {
    const rows = document.querySelectorAll("tr[data-id]");
    const now = Math.floor(Date.now() / 1000);
    let shouldRefresh = false;

    rows.forEach(row => {
        const expiry = parseInt(row.dataset.expires);
        const status = row.dataset.status;

        if (status !== "HOLD") return;

        let remaining = expiry - now;
        const timerCell = row.querySelector(".timerCell");
        const statusCell = row.querySelector(".statusCell");
        const audio = document.getElementById("warningSound");

        // If already expired
        if (remaining <= 0) {
            timerCell.innerHTML = "<span style='color:red'>Expired</span>";
            statusCell.textContent = "CANCELLED";
            row.dataset.status = "CANCELLED";
            shouldRefresh = true;
            return;
        }

        // Convert time
        let min = Math.floor(remaining / 60);
        let sec = remaining % 60;
        let text = `${min}:${sec.toString().padStart(2, '0')} sec`;

        // Buzzer + blink under 10 sec
        if (remaining <= 10) {
            timerCell.innerHTML = `<span style='color:red; font-weight:bold;' class='blink'>${text}</span>`;
            audio.play();
        }
        else if (remaining <= 30) {
            timerCell.innerHTML = `<span style='color:orange'>${text}</span>`;
        }
        else {
            timerCell.innerHTML = text;
        }
    });

    if (shouldRefresh) {
        setTimeout(() => {
            window.location.reload();
        }, 1500);
    }
}

setInterval(updateTimers, 1000);
updateTimers();
</script>

<style>
.blink {
    animation: blinker 1s infinite;
}
@keyframes blinker {
    50% { opacity: 0.2; }
}
</style>

</div>

{% endblock %}
