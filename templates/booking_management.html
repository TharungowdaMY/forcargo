{% extends "base.html" %}
{% block content %}

<h1 class="page-title">Booking Management</h1>

<div class="neon-box">

<table style="width:100%; color:white; border-collapse: collapse;">
    <tr style="background:#111;">
        <th>ID</th>
        <th>Flight</th>
        <th>Weights</th>
        <th>Price/kg</th>
        <th>Total</th>
        <th>Status</th>
        <th>Action</th>
    </tr>

{% for b in bookings %}
<tr style="text-align:center; border-bottom:1px solid #333;">
    <td>{{ b['id'] }}</td>
    <td>{{ b['flight_id'] }}</td>

    <td>
        Actual: {{ b['actual_weight'] or 0 }} kg<br>
        Volumetric: {{ (b['volumetric_weight'] or 0)|round(2) }} kg<br>
        Charged: <b>{{ (b['chargeable_weight'] or 0)|round(2) }} kg</b>
    </td>

    <td>‚Çπ{{ b['price'] }}</td>
    <td><b>‚Çπ{{ (b['total'] or 0)|round(2) }}</b></td>

    <td>{{ b['status'] }}</td>

    <td>

        <!-- ‚≠ê CHAT BUTTON ADDED HERE -->
        <a href="/chat/{{ b['id'] }}" class="neon-btn" style="margin-bottom:5px;">Chat</a>
        <br>

       {% if b['status'] == "CONFIRMED" %}

    {% set now = (namespace().t | default(0)) %}
    {% set elapsed = (now - b['confirmed_at']) if b['confirmed_at'] else 9999 %}

    {% if elapsed <= 300 %}

        <!-- üü¢ FREE WINDOW -->
        <div style="display:flex; gap:6px; justify-content:center;">
            <a href="/cancel_booking/{{ b['id'] }}" class="neon-btn">Cancel (Free)</a>
            <a href="/modify_booking/{{ b['id'] }}" class="neon-btn">Modify (Free)</a>
        </div>
        <small style="color:#00ffcc;">‚è± Free window</small>

    {% else %}

        <!-- üî¥ PAID WINDOW -->
        <div style="display:flex; gap:6px; justify-content:center;">
            <a href="/cancel_booking/{{ b['id'] }}?paid=1" class="neon-btn">Cancel (‚Çπ Fee)</a>
            <a href="/modify_booking/{{ b['id'] }}?paid=1" class="neon-btn">Modify (‚Çπ Fee)</a>
        </div>
        <small style="color:#ff5555;">Penalty applies</small>

    {% endif %}

{% else %}
    {{ b['status'] }}
{% endif %}

    </td>
</tr>
{% endfor %}
</table>
<!-- AUDIO ALERT FOR FINAL 10 SECONDS -->
<audio id="warningSound">
    <source src="https://www.soundjay.com/buttons/sounds/beep-05.mp3">
</audio>

<script>
function updateTimers() {
    const rows = document.querySelectorAll("tr[data-id]");
    const now = Math.floor(Date.now() / 1000);
    let shouldRefresh = false;

    rows.forEach(row => {
        const expiry = parseInt(row.dataset.expires);
        const status = row.dataset.status;

        if (status !== "HOLD") return;

        let remaining = expiry - now;
        const timerCell = row.querySelector(".timerCell");
        const statusCell = row.querySelector(".statusCell");
        const audio = document.getElementById("warningSound");

        // If already expired
        if (remaining <= 0) {
            timerCell.innerHTML = "<span style='color:red'>Expired</span>";
            statusCell.textContent = "CANCELLED";
            row.dataset.status = "CANCELLED";
            shouldRefresh = true;
            return;
        }

        // Convert time
        let min = Math.floor(remaining / 60);
        let sec = remaining % 60;
        let text = `${min}:${sec.toString().padStart(2, '0')} sec`;

        // Buzzer + blink under 10 sec
        if (remaining <= 10) {
            timerCell.innerHTML = `<span style='color:red; font-weight:bold;' class='blink'>${text}</span>`;
            audio.play();
        }
        else if (remaining <= 30) {
            timerCell.innerHTML = `<span style='color:orange'>${text}</span>`;
        }
        else {
            timerCell.innerHTML = text;
        }
    });

    if (shouldRefresh) {
        setTimeout(() => {
            window.location.reload();
        }, 1500);
    }
}

setInterval(updateTimers, 1000);
updateTimers();
</script>

<style>
.blink {
    animation: blinker 1s infinite;
}
@keyframes blinker {
    50% { opacity: 0.2; }
}
</style>

</div>

{% endblock %}
