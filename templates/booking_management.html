{% extends "base.html" %}
{% block content %}

<h1 class="page-title">Booking Management</h1>

<div class="neon-box">

<table id="bookingTable" style="width:100%; color:white; border-collapse: collapse;">
    <tr style="background:#111;">
        <th>ID</th>
        <th>Flight</th>
        <th>Weight Details</th>
        <th>Price / kg</th>
        <th>Total</th>
        <th>Status</th>
        <th>Time Left</th>
        <th>Action</th>
    </tr>

{% for b in bookings %}
<tr data-id="{{ b['id'] }}"
    data-status="{{ b['status'] }}"
    data-expires="{{ b['expires_at'] or 0 }}"
    style="border-bottom:1px solid #333; text-align:center;">

    <td>{{ b['id'] }}</td>

    <td>{{ b['flight_id'] }}</td>

    <td>
        <b>Actual:</b> {{ b['actual_weight'] or 0 }} kg<br>
        <b>Volumetric:</b> {{ (b['volumetric_weight'] or 0)|round(2) }} kg<br>
        <b>Charged:</b>
        <span style="color:#0ff;">
            {{ (b['chargeable_weight'] or 0)|round(2) }} kg
        </span>
    </td>

    <td>‚Çπ{{ b['price'] }}</td>

    <td>
        <b>‚Çπ{{ (b['total'] or 0)|round(2) }}</b>
    </td>

    <td class="statusCell">
        {{ b['status'] }}
    </td>

    <td class="timerCell">
        {% if b['status'] == 'HOLD' %}
            <span class="timer">--</span>
        {% else %}
            -
        {% endif %}
    </td>

    <td class="actionCell">
        {% if b['status'] == 'HOLD' %}
            <form method="POST" action="/confirm_booking">
                <input type="hidden" name="id" value="{{ b['id'] }}">
                <button class="neon-btn">‚úÖ Confirm</button>
            </form>

        {% elif b['status'] == 'CONFIRMED' %}
            ‚úÖ Confirmed <br>
            <a href="/download_invoice/{{ b['id'] }}" class="neon-btn">
                üìÑ Invoice
            </a>

        {% else %}
            ‚ùå Cancelled
        {% endif %}
    </td>

</tr>
{% endfor %}
</table>

</div>

<!-- üîä BEEP SOUND -->
<audio id="beepSound">
    <source src="https://www.soundjay.com/buttons/sounds/beep-05.mp3">
</audio>

<style>
.neon-btn{
    background:#ff0077;
    color:white;
    padding:8px 14px;
    border:none;
    border-radius:6px;
    cursor:pointer;
    box-shadow:0 0 10px #ff0077;
}

.blink{
    animation: blink 1s infinite;
}

@keyframes blink{
    0%{opacity:1}
    50%{opacity:0.3}
    100%{opacity:1}
}
</style>

<script>
function updateTimers(){
    const rows = document.querySelectorAll("#bookingTable tr[data-id]");
    const now = Math.floor(Date.now()/1000);
    const beep = document.getElementById("beepSound");

    rows.forEach(row=>{
        const status = row.dataset.status;
        if(status !== "HOLD") return;

        const expiry = parseInt(row.dataset.expires);
        const timerCell = row.querySelector(".timerCell");
        const statusCell = row.querySelector(".statusCell");

        let remaining = expiry - now;

        if(remaining <= 0){
            timerCell.innerHTML = "<span style='color:red;'>Expired</span>";
            statusCell.innerText = "CANCELLED";
            row.dataset.status = "CANCELLED";
            setTimeout(()=>location.reload(), 1500);
            return;
        }

        let min = Math.floor(remaining / 60);
        let sec = remaining % 60;
        let text = `${min}:${sec.toString().padStart(2,'0')}`;

        if(remaining <= 10){
            timerCell.innerHTML =
              `<span class="blink" style="color:red;">${text}</span>`;
            beep.play();
        }
        else if(remaining <= 30){
            timerCell.innerHTML =
              `<span style="color:orange;">${text}</span>`;
        }
        else{
            timerCell.innerHTML = text;
        }
    });
}

setInterval(updateTimers,1000);
updateTimers();
</script>

{% endblock %}
